<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#238636">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gym Tracker">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è Gym Tracker</h1>

        <div class="top-actions">
            <button class="btn btn-primary" id="addTrainingBtn">+ Add Training</button>
            <button class="btn btn-edit" id="editSelectedBtn" disabled title="Select a training to edit">‚úé Edit</button>
            <button class="btn btn-pdf" id="downloadPdfBtn" disabled title="Select trainings to download PDF">‚§ì PDF</button>
            <button class="btn btn-delete" id="deleteSelectedBtn" disabled title="Select trainings to delete">‚úï Delete</button>
            <button class="btn btn-secondary btn-toggle-filters" id="toggleFiltersBtn">üîç Filters</button>
            <button class="btn btn-secondary" id="toggleDataBtn">üíæ Data</button>
        </div>

        <!-- Data import/export bar -->
        <div class="data-bar collapsed" id="dataBar">
            <div class="data-bar-inner">
                <p class="data-bar-info">Export your data as JSON to back up or transfer between devices. Import a previously exported file to restore.</p>
                <div class="data-bar-actions">
                    <button class="btn btn-small btn-primary" id="exportJsonBtn">‚¨á Export JSON</button>
                    <button class="btn btn-small btn-secondary" id="importJsonBtn">‚¨Ü Import JSON</button>
                    <input type="file" id="importFileInput" accept=".json,application/json" style="display:none">
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar collapsed" id="filtersBar">
            <div class="filter-group">
                <label for="filterName">Name</label>
                <input type="text" id="filterName" placeholder="Search name...">
            </div>
            <div class="filter-group">
                <label for="filterDateFrom">From</label>
                <input type="date" id="filterDateFrom">
            </div>
            <div class="filter-group">
                <label for="filterDateTo">To</label>
                <input type="date" id="filterDateTo">
            </div>
            <button class="btn btn-secondary btn-small" id="clearFiltersBtn">Clear Filters</button>
        </div>

        <!-- Selection info bar -->
        <div class="selection-toolbar" id="selectionToolbar">
            <span id="selectionCount">0 selected</span>
            <button class="btn btn-small btn-secondary" id="clearSelectionBtn">Clear selection</button>
        </div>

        <div class="table-wrapper">
            <table id="trainingsTable">
                <thead>
                    <tr>
                        <th class="th-checkbox"><input type="checkbox" id="selectAllCheckbox" title="Select all"></th>
                        <th class="sortable" data-sort="name">Name <span class="sort-icon" id="sortIconName"></span></th>
                        <th class="sortable" data-sort="date">Date <span class="sort-icon" id="sortIconDate"></span></th>
                        <th class="sortable" data-sort="exercises">Ex. <span class="sort-icon" id="sortIconExercises"></span></th>
                        <th class="sortable" data-sort="rating">Rating <span class="sort-icon" id="sortIconRating"></span></th>
                    </tr>
                </thead>
                <tbody id="trainingsBody">
                </tbody>
            </table>
        </div>
        <p id="emptyMessage" class="empty-message">No trainings yet. Click "+ Add Training" to get started!</p>
    </div>

    <!-- Add/Edit Training Modal -->
    <div class="modal-overlay" id="trainingModal">
        <div class="modal">
            <h2 id="trainingModalTitle">Add Training</h2>
            <form id="trainingForm">
                <div class="form-group">
                    <label for="trainingName">Training Name</label>
                    <input type="text" id="trainingName" required placeholder="e.g., Upper Body Day">
                </div>
                <div class="form-group">
                    <label for="trainingDate">Date</label>
                    <input type="date" id="trainingDate" required>
                    <div class="date-helpers">
                        <button type="button" class="date-helper-btn" data-offset="0">Today</button>
                        <button type="button" class="date-helper-btn" data-offset="-1">Yesterday</button>
                        <button type="button" class="date-helper-btn" data-offset="-2">2 days ago</button>
                        <button type="button" class="date-helper-btn" data-offset="-3">3 days ago</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelTrainingBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import confirmation modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h2>Import Data</h2>
            <p class="import-warning">‚ö†Ô∏è How would you like to import?</p>
            <p class="import-detail" id="importDetail"></p>
            <div class="modal-actions import-actions">
                <button type="button" class="btn btn-secondary" id="importCancelBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="importMergeBtn">Merge (keep existing)</button>
                <button type="button" class="btn btn-delete" id="importReplaceBtn">Replace all</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        const trainingsBody = document.getElementById('trainingsBody');
        const trainingModal = document.getElementById('trainingModal');
        const trainingForm = document.getElementById('trainingForm');
        const trainingModalTitle = document.getElementById('trainingModalTitle');
        const trainingNameInput = document.getElementById('trainingName');
        const trainingDateInput = document.getElementById('trainingDate');
        const emptyMessage = document.getElementById('emptyMessage');
        const filterName = document.getElementById('filterName');
        const filterDateFrom = document.getElementById('filterDateFrom');
        const filterDateTo = document.getElementById('filterDateTo');
        const filtersBar = document.getElementById('filtersBar');
        const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const selectionToolbar = document.getElementById('selectionToolbar');
        const selectionCount = document.getElementById('selectionCount');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const editSelectedBtn = document.getElementById('editSelectedBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const dataBar = document.getElementById('dataBar');
        const toggleDataBtn = document.getElementById('toggleDataBtn');
        const importModal = document.getElementById('importModal');
        const importDetail = document.getElementById('importDetail');
        const importFileInput = document.getElementById('importFileInput');
        let editingTrainingId = null;
        let pendingImportData = null;

        let sortColumn = 'date';
        let sortDirection = 'desc';
        const selectedIds = new Set();

        toggleFiltersBtn.addEventListener('click', () => {
            filtersBar.classList.toggle('collapsed');
            toggleFiltersBtn.classList.toggle('active');
        });

        toggleDataBtn.addEventListener('click', () => {
            dataBar.classList.toggle('collapsed');
            toggleDataBtn.classList.toggle('active');
        });

        // Date helper buttons
        document.querySelectorAll('.date-helper-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const offset = parseInt(btn.dataset.offset);
                const date = new Date();
                date.setDate(date.getDate() + offset);
                trainingDateInput.value = date.toISOString().split('T')[0];
                document.querySelectorAll('.date-helper-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        trainingDateInput.addEventListener('change', () => {
            updateDateHelperHighlight();
        });

        function updateDateHelperHighlight() {
            const val = trainingDateInput.value;
            document.querySelectorAll('.date-helper-btn').forEach(btn => {
                const offset = parseInt(btn.dataset.offset);
                const date = new Date();
                date.setDate(date.getDate() + offset);
                const dateStr = date.toISOString().split('T')[0];
                btn.classList.toggle('active', val === dateStr);
            });
        }

        // ---- Export JSON ----
        document.getElementById('exportJsonBtn').addEventListener('click', () => {
            const data = exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gym_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // ---- Import JSON ----
        document.getElementById('importJsonBtn').addEventListener('click', () => {
            importFileInput.click();
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parsed = JSON.parse(event.target.result);
                    if (!parsed.version || !Array.isArray(parsed.trainings)) {
                        alert('Invalid file format. Please select a valid Gym Tracker export file.');
                        return;
                    }
                    pendingImportData = parsed.trainings;
                    const existing = getTrainings();
                    importDetail.textContent = `File contains ${parsed.trainings.length} training(s). You currently have ${existing.length} training(s).`;
                    importModal.classList.add('active');
                } catch (err) {
                    alert('Error reading file. Please ensure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);
            importFileInput.value = '';
        });

        document.getElementById('importCancelBtn').addEventListener('click', () => {
            importModal.classList.remove('active');
            pendingImportData = null;
        });

        document.getElementById('importMergeBtn').addEventListener('click', () => {
            if (pendingImportData) {
                importData(pendingImportData, 'merge');
                importModal.classList.remove('active');
                pendingImportData = null;
                selectedIds.clear();
                renderTrainings();
            }
        });

        document.getElementById('importReplaceBtn').addEventListener('click', () => {
            if (pendingImportData) {
                importData(pendingImportData, 'replace');
                importModal.classList.remove('active');
                pendingImportData = null;
                selectedIds.clear();
                renderTrainings();
            }
        });

        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) {
                importModal.classList.remove('active');
                pendingImportData = null;
            }
        });

        function getFilteredAndSortedTrainings() {
            let trainings = getTrainings();

            const nameQuery = filterName.value.trim().toLowerCase();
            if (nameQuery) trainings = trainings.filter(t => t.name.toLowerCase().includes(nameQuery));

            const from = filterDateFrom.value;
            const to = filterDateTo.value;
            if (from) trainings = trainings.filter(t => t.date >= from);
            if (to) trainings = trainings.filter(t => t.date <= to);

            trainings.sort((a, b) => {
                let valA, valB;
                if (sortColumn === 'name') {
                    valA = a.name.toLowerCase();
                    valB = b.name.toLowerCase();
                } else if (sortColumn === 'date') {
                    valA = a.date;
                    valB = b.date;
                } else if (sortColumn === 'exercises') {
                    valA = a.exercises.length;
                    valB = b.exercises.length;
                } else if (sortColumn === 'rating') {
                    valA = getAverageRating(a);
                    valB = getAverageRating(b);
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return trainings;
        }

        function updateSortIcons() {
            document.getElementById('sortIconName').textContent = '';
            document.getElementById('sortIconDate').textContent = '';
            document.getElementById('sortIconExercises').textContent = '';
            document.getElementById('sortIconRating').textContent = '';
            const icon = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
            if (sortColumn === 'name') document.getElementById('sortIconName').textContent = icon;
            if (sortColumn === 'date') document.getElementById('sortIconDate').textContent = icon;
            if (sortColumn === 'exercises') document.getElementById('sortIconExercises').textContent = icon;
            if (sortColumn === 'rating') document.getElementById('sortIconRating').textContent = icon;
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            if (window.innerWidth <= 480) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function updateSelectionUI() {
            const count = selectedIds.size;
            const allTrainings = getTrainings();
            const hasTrainings = allTrainings.length > 0;

            // PDF: enabled when ‚â•1 selected
            downloadPdfBtn.style.display = hasTrainings ? '' : 'none';
            downloadPdfBtn.disabled = count === 0;
            downloadPdfBtn.title = count > 0
                ? `Download ${count} training${count > 1 ? 's' : ''} as PDF`
                : 'Select trainings to download PDF';

            // Edit: enabled only when exactly 1 selected
            editSelectedBtn.style.display = hasTrainings ? '' : 'none';
            editSelectedBtn.disabled = count !== 1;
            editSelectedBtn.title = count === 1
                ? 'Edit selected training'
                : 'Select exactly one training to edit';

            // Delete: enabled when ‚â•1 selected
            deleteSelectedBtn.style.display = hasTrainings ? '' : 'none';
            deleteSelectedBtn.disabled = count === 0;
            deleteSelectedBtn.title = count > 0
                ? `Delete ${count} training${count > 1 ? 's' : ''}`
                : 'Select trainings to delete';

            // Selection toolbar
            if (count > 0) {
                selectionToolbar.classList.add('visible');
                selectionCount.textContent = `${count} selected`;
            } else {
                selectionToolbar.classList.remove('visible');
            }

            // Select-all checkbox
            const visibleTrainings = getFilteredAndSortedTrainings();
            const allVisibleSelected = visibleTrainings.length > 0 && visibleTrainings.every(t => selectedIds.has(t.id));
            const someSelected = visibleTrainings.some(t => selectedIds.has(t.id));
            selectAllCheckbox.checked = allVisibleSelected;
            selectAllCheckbox.indeterminate = someSelected && !allVisibleSelected;

            // Row highlights
            document.querySelectorAll('#trainingsBody tr').forEach(tr => {
                const id = tr.dataset.id;
                if (id && selectedIds.has(id)) {
                    tr.classList.add('selected');
                } else {
                    tr.classList.remove('selected');
                }
            });
        }

        function renderTrainings() {
            const trainings = getFilteredAndSortedTrainings();
            const allTrainings = getTrainings();
            trainingsBody.innerHTML = '';

            toggleFiltersBtn.style.display = allTrainings.length === 0 ? 'none' : '';

            if (trainings.length === 0) {
                emptyMessage.style.display = 'block';
                emptyMessage.textContent = allTrainings.length === 0
                    ? 'No trainings yet. Click "+ Add Training" to get started!'
                    : 'No trainings match your filters.';
                document.getElementById('trainingsTable').style.display = 'none';
                updateSelectionUI();
                return;
            }

            emptyMessage.style.display = 'none';
            document.getElementById('trainingsTable').style.display = 'table';
            updateSortIcons();

            trainings.forEach(training => {
                const tr = document.createElement('tr');
                tr.dataset.id = training.id;
                const checked = selectedIds.has(training.id) ? 'checked' : '';
                const avg = getAverageRating(training);

                tr.innerHTML = `
                    <td class="td-checkbox"><input type="checkbox" class="row-checkbox" data-id="${training.id}" ${checked}></td>
                    <td class="clickable" data-id="${training.id}">${training.name}</td>
                    <td class="clickable" data-id="${training.id}">${formatDateShort(training.date)}</td>
                    <td class="clickable" data-id="${training.id}">${training.exercises.length}</td>
                    <td class="clickable td-rating" data-id="${training.id}">${renderStarsReadonly(avg)}</td>
                `;
                trainingsBody.appendChild(tr);
            });

            updateSelectionUI();
        }

        function openTrainingModal(training = null) {
            if (training) {
                trainingModalTitle.textContent = 'Edit Training';
                trainingNameInput.value = training.name;
                trainingDateInput.value = training.date;
                editingTrainingId = training.id;
            } else {
                trainingModalTitle.textContent = 'Add Training';
                trainingNameInput.value = '';
                trainingDateInput.value = new Date().toISOString().split('T')[0];
                editingTrainingId = null;
            }
            updateDateHelperHighlight();
            trainingModal.classList.add('active');
            trainingNameInput.focus();
        }

        function closeTrainingModal() {
            trainingModal.classList.remove('active');
            editingTrainingId = null;
        }

        // ---- PDF Export ----
        function getTotalRepsForPdf(exercise) {
            const s = exercise.series || [null, null, null, null, null, null];
            let total = 0;
            for (let i = 0; i < MAX_SERIES; i++) {
                if (s[i] != null && !isNaN(s[i])) {
                    total += s[i];
                }
            }
            return total;
        }

        function exportPDF(trainingIds) {
            const allTrainings = getTrainings();
            const trainings = trainingIds.map(id => allTrainings.find(t => t.id === id)).filter(Boolean);
            if (trainings.length === 0) return;

            trainings.sort((a, b) => new Date(a.date) - new Date(b.date));

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();

            trainings.forEach((training, tIndex) => {
                if (tIndex > 0) doc.addPage();

                let y = 20;

                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(30);
                doc.text(training.name, pageWidth / 2, y, { align: 'center' });
                y += 8;

                const dateObj = new Date(training.date + 'T00:00:00');
                const dateStr = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100);
                doc.text(dateStr, pageWidth / 2, y, { align: 'center' });
                y += 6;

                doc.setDrawColor(200);
                doc.setLineWidth(0.5);
                doc.line(14, y, pageWidth - 14, y);
                y += 8;

                doc.setTextColor(60);
                doc.setFontSize(11);
                doc.text(`Total exercises: ${training.exercises.length}`, 14, y);

                let grandTotal = 0;
                training.exercises.forEach(ex => { grandTotal += getTotalRepsForPdf(ex); });
                doc.text(`Total repetitions: ${grandTotal}`, 90, y);
                y += 8;

                if (training.exercises.length === 0) {
                    doc.setFontSize(12);
                    doc.setTextColor(150);
                    doc.text('No exercises recorded for this training.', pageWidth / 2, y + 10, { align: 'center' });
                } else {
                    const grouped = {};
                    training.exercises.forEach(ex => {
                        const type = ex.type || 'Uncategorized';
                        if (!grouped[type]) grouped[type] = [];
                        grouped[type].push(ex);
                    });

                    Object.keys(grouped).forEach(type => {
                        doc.setFontSize(13);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(40);
                        doc.text(type, 14, y);
                        y += 2;

                        const tableRows = grouped[type].map(ex => {
                            const s = ex.series || [null, null, null, null, null, null];
                            const total = getTotalRepsForPdf(ex);
                            return [
                                ex.name || '-',
                                s[0] != null ? String(s[0]) : '-',
                                s[1] != null ? String(s[1]) : '-',
                                s[2] != null ? String(s[2]) : '-',
                                s[3] != null ? String(s[3]) : '-',
                                s[4] != null ? String(s[4]) : '-',
                                s[5] != null ? String(s[5]) : '-',
                                total > 0 ? String(total) : '-'
                            ];
                        });

                        doc.autoTable({
                            startY: y,
                            head: [['Exercise', 'S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'Total']],
                            body: tableRows,
                            theme: 'grid',
                            margin: { left: 14, right: 14 },
                            headStyles: {
                                fillColor: [35, 134, 54],
                                textColor: 255,
                                fontStyle: 'bold',
                                fontSize: 10,
                                halign: 'center'
                            },
                            columnStyles: {
                                0: { cellWidth: 'auto', halign: 'left' },
                                1: { cellWidth: 15, halign: 'center' },
                                2: { cellWidth: 15, halign: 'center' },
                                3: { cellWidth: 15, halign: 'center' },
                                4: { cellWidth: 15, halign: 'center' },
                                5: { cellWidth: 15, halign: 'center' },
                                6: { cellWidth: 15, halign: 'center' },
                                7: { cellWidth: 20, halign: 'center', fontStyle: 'bold' }
                            },
                            bodyStyles: { fontSize: 10, textColor: 50 },
                            alternateRowStyles: { fillColor: [245, 245, 245] }
                        });

                        y = doc.lastAutoTable.finalY + 10;
                    });
                }
            });

            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(180);
                doc.text(
                    `Gym Tracker ‚Äî Generated ${new Date().toLocaleDateString()} ‚Äî Page ${i} of ${totalPages}`,
                    pageWidth / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }

            let filename;
            if (trainings.length === 1) {
                const safeName = trainings[0].name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                filename = `${safeName}_${trainings[0].date}.pdf`;
            } else {
                filename = `gym_tracker_${trainings.length}_trainings.pdf`;
            }
            doc.save(filename);
        }

        // ---- Event Listeners ----

        document.getElementById('addTrainingBtn').addEventListener('click', () => openTrainingModal());
        document.getElementById('cancelTrainingBtn').addEventListener('click', closeTrainingModal);

        trainingModal.addEventListener('click', (e) => {
            if (e.target === trainingModal) closeTrainingModal();
        });

        trainingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = trainingNameInput.value.trim();
            const date = trainingDateInput.value;
            if (!name || !date) return;

            if (editingTrainingId) {
                updateTraining(editingTrainingId, { name, date });
            } else {
                const training = addTraining(name, date);
                closeTrainingModal();
                window.location.href = `training.html?id=${training.id}`;
                return;
            }
            closeTrainingModal();
            renderTrainings();
        });

        // Row clicks ‚Äî navigate to training detail
        trainingsBody.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('clickable') || target.closest('.clickable')) {
                const clickable = target.classList.contains('clickable') ? target : target.closest('.clickable');
                const navId = clickable.dataset.id;
                if (navId) window.location.href = `training.html?id=${navId}`;
            }
        });

        // Checkbox change on individual rows
        trainingsBody.addEventListener('change', (e) => {
            if (!e.target.classList.contains('row-checkbox')) return;
            const id = e.target.dataset.id;
            if (e.target.checked) {
                selectedIds.add(id);
            } else {
                selectedIds.delete(id);
            }
            updateSelectionUI();
        });

        // Select all
        selectAllCheckbox.addEventListener('change', () => {
            const visibleTrainings = getFilteredAndSortedTrainings();
            if (selectAllCheckbox.checked) {
                visibleTrainings.forEach(t => selectedIds.add(t.id));
            } else {
                visibleTrainings.forEach(t => selectedIds.delete(t.id));
            }
            renderTrainings();
        });

        // Edit selected (exactly 1)
        editSelectedBtn.addEventListener('click', () => {
            if (selectedIds.size !== 1) return;
            const id = Array.from(selectedIds)[0];
            const training = getTrainings().find(t => t.id === id);
            if (training) openTrainingModal(training);
        });

        // Download PDF
        downloadPdfBtn.addEventListener('click', () => {
            if (selectedIds.size === 0) return;
            exportPDF(Array.from(selectedIds));
        });

        // Delete selected
        deleteSelectedBtn.addEventListener('click', () => {
            if (selectedIds.size === 0) return;
            const count = selectedIds.size;
            const msg = count === 1
                ? 'Are you sure you want to delete this training?'
                : `Are you sure you want to delete ${count} trainings?`;
            if (!confirm(msg)) return;

            Array.from(selectedIds).forEach(id => deleteTraining(id));
            selectedIds.clear();
            renderTrainings();
        });

        // Clear selection
        clearSelectionBtn.addEventListener('click', () => {
            selectedIds.clear();
            renderTrainings();
        });

        // Sort
        document.querySelectorAll('#trainingsTable th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.sort;
                if (sortColumn === col) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = col;
                    sortDirection = 'asc';
                }
                renderTrainings();
            });
        });

        // Filters
        filterName.addEventListener('input', renderTrainings);
        filterDateFrom.addEventListener('change', renderTrainings);
        filterDateTo.addEventListener('change', renderTrainings);

        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            filterName.value = '';
            filterDateFrom.value = '';
            filterDateTo.value = '';
            renderTrainings();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTrainingModal();
                importModal.classList.remove('active');
                pendingImportData = null;
            }
        });

        window.addEventListener('resize', renderTrainings);

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then((reg) => {
                console.log('Service Worker registered:', reg.scope);
            }).catch((err) => {
                console.log('Service Worker registration failed:', err);
            });
        }

        renderTrainings();
    </script>
</body>
</html>